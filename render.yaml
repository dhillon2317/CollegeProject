services:
  - type: web
    name: complaint-analyzer
    env: python
    buildCommand: |
      #!/bin/bash
      # Exit on error and print commands for debugging
      set -exo pipefail
      
      # Debug info
      echo "=== Build Script Started ==="
      echo "Current directory: $(pwd)"
      echo "Directory contents:"
      ls -la
      
      # Set Python path
      export PYTHONPATH="${PYTHONPATH}:/opt/render/project/src"
      
      # Check models directory
      echo "=== Checking for models directory ==="
      MODELS_DIR="./sbackend/camplaint-analyzer/models"
      if [ -d "$MODELS_DIR" ]; then
        echo "‚úÖ Models directory found at $MODELS_DIR"
        echo "üìÇ Contents:"
        ls -la "$MODELS_DIR"
      else
        echo "‚ö†Ô∏è  Warning: Models directory not found at $MODELS_DIR"
        echo "üìÇ Current directory structure (top level):"
        ls -la
        # Don't fail the build if models directory is missing, just warn
      fi
      
      # Set up Node.js
      echo "=== Setting up Node.js ==="
      export NVM_DIR="$HOME/.nvm"
      
      # Load nvm
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      
      # Install and use Node.js 16
      echo "Installing Node.js 16.20.2..."
      nvm install 16.20.2 || { echo "Failed to install Node.js 16.20.2"; exit 1; }
      nvm use 16.20.2
      
      # Verify installation
      echo "Node.js version: $(node -v)"
      echo "npm version: $(npm -v)"
      
      # Install Python dependencies
      echo "=== Installing Python dependencies ==="
      python -m pip install --upgrade pip || { echo "Failed to upgrade pip"; exit 1; }
      pip install --no-cache-dir -U setuptools wheel || { echo "Failed to install setuptools/wheel"; exit 1; }
      
      # Install core numerical packages first
      echo "Installing core numerical packages..."
      pip install --no-cache-dir numpy==1.23.5 || { echo "Failed to install numpy"; exit 1; }
      pip install --no-cache-dir scipy==1.10.1 || { echo "Failed to install scipy"; exit 1; }
      
      # Install requirements with proper error handling
      echo "Installing project requirements from root requirements.txt..."
      if [ -f "requirements.txt" ]; then
        pip install --no-cache-dir -r requirements.txt || \
          { echo "‚ùå Failed to install requirements"; exit 1; }
        echo "‚úÖ Successfully installed requirements"
      else
        echo "‚ùå Error: requirements.txt not found in the root directory"
        exit 1
      fi
      
      # Install spaCy and its dependencies
      echo "Installing spaCy and dependencies..."
      pip install --no-cache-dir --no-deps spacy==3.8.7 || { echo "Failed to install spacy"; exit 1; }
      pip install --no-cache-dir spacy-legacy==3.0.12 spacy-loggers==1.0.5 \
        wasabi==1.1.3 srsly==2.5.1 cymem==2.0.11 preshed==3.0.10 \
        thinc==8.3.6 pydantic==1.10.8 typer==0.9.0 || \
        { echo "Failed to install spacy dependencies"; exit 1; }
      
      # Build frontend
      echo "=== Building Frontend ==="
      if [ -d "frontend/complain-analyzer-ai" ]; then
        cd frontend/complain-analyzer-ai || { echo "Failed to enter frontend directory"; exit 1; }
        
        # Clean and install dependencies
        echo "Cleaning and installing frontend dependencies..."
        rm -rf node_modules package-lock.json .next
        npm cache clean --force
        export NODE_OPTIONS=--openssl-legacy-provider
        
        # Install frontend dependencies
        npm install || { echo "Failed to install frontend dependencies"; exit 1; }
        
        # Build frontend
        echo "Building frontend..."
        NODE_OPTIONS=--openssl-legacy-provider npm run build || \
          { echo "Frontend build failed"; exit 1; }
        
        # Verify build
        if [ -d ".next" ]; then
          echo "‚úÖ Frontend build successful"
        else
          echo "‚ùå Frontend build failed"
          exit 1
        fi
        cd ../..
      else
        echo "‚ö†Ô∏è  Warning: Frontend directory not found, skipping frontend build"
      fi
      
      # Final check
      echo "=== Final Verification ==="
      if [ -f "sbackend/camplaint-analyzer/models/category_model.pkl" ]; then
        echo "‚úÖ Model file found"
      else
        echo "‚ö†Ô∏è  Warning: Model file not found"
      fi
      
      echo "=== Build Script Completed Successfully ==="
    
    startCommand: "gunicorn --bind :$PORT --workers 1 --threads 2 --timeout 120 wsgi:application"
    
    envVars:
      - key: PYTHON_VERSION
        value: 3.9.0
      - key: PYTHONUNBUFFERED
        value: 1
      - key: PORT
        value: 10000
      - key: PYTHONPATH
        value: /opt/render/project/src
    
    plan: free
    healthCheckPath: /health
