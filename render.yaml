services:
  - type: web
    name: complaint-analyzer
    env: python
    buildCommand: |
      #!/bin/bash
      set -e  # Exit on error
      
      # Debug info
      echo "=== Build Script Started ==="
      echo "Current directory: $(pwd)"
      echo "Directory contents:"
      ls -la
      
      # Set Python path
      export PYTHONPATH="${PYTHONPATH}:/opt/render/project/src"
      
      # Check models directory
      echo "=== Checking for models directory ==="
      MODELS_DIR="sbackend/camplaint-analyzer/models"
      
      if [ -d "$MODELS_DIR" ]; then
        echo "‚úÖ Models directory found at $MODELS_DIR"
        echo "üìÇ Contents:"
        ls -la "$MODELS_DIR"
      else
        echo "‚ùå Models directory not found at $MODELS_DIR"
        echo "üìÇ Current directory structure (top level):"
        ls -la
      fi
      
      # Set up Node.js
      echo "=== Setting up Node.js ==="
      export NVM_DIR="$HOME/.nvm"
      
      # Install nvm if not present
      if [ ! -d "$NVM_DIR" ]; then
        echo "Installing nvm..."
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
      fi
      
      # Load nvm
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      
      # Install and use Node.js 16
      echo "Installing Node.js 16.20.2..."
      nvm install 16.20.2
      nvm use 16.20.2
      
      # Verify installation
      echo "Node.js version: $(node -v)"
      echo "npm version: $(npm -v)"
      
      # Build frontend
      echo "=== Building Frontend ==="
      cd frontend/complain-analyzer-ai
      # Clean and install dependencies
      rm -rf node_modules package-lock.json .next
      npm cache clean --force
      export NODE_OPTIONS=--openssl-legacy-provider
      
      # Install Python dependencies
      echo "=== Installing Python dependencies ==="
      python -m pip install --upgrade pip
      pip install --no-cache-dir -U setuptools wheel
      
      # First install numpy and scipy with compatible versions
      pip install --no-cache-dir numpy==1.23.5
      pip install --no-cache-dir scipy==1.10.1
      
      # Now install other requirements with --no-deps to prevent overriding our versions
      pip install --no-cache-dir --no-deps -r sbackend/camplaint-analyzer/requirements.txt
      
      # Finally install spacy with --no-deps and then its dependencies
      pip install --no-cache-dir --no-deps spacy==3.8.7
      pip install --no-cache-dir spacy-legacy==3.0.12 spacy-loggers==1.0.5 \
        wasabi==1.1.3 srsly==2.5.1 cymem==2.0.11 preshed==3.0.10 \
        thinc==8.3.6 pydantic==1.10.8 typer==0.9.0
      
      echo "=== Building Frontend ==="
      NODE_OPTIONS=--openssl-legacy-provider npm run build
      
      # Verify build
      if [ -d ".next" ]; then
        echo "‚úÖ Frontend build successful"
      else
        echo "‚ùå Frontend build failed"
        exit 1
      fi
      
      cd ../..
      
      # Final check
      echo "=== Final Verification ==="
      if [ -f "sbackend/camplaint-analyzer/models/category_model.pkl" ]; then
        echo "‚úÖ Model file found"
      else
        echo "‚ö†Ô∏è  Warning: Model file not found"
      fi
      
      echo "=== Build Script Completed Successfully ==="
    
    startCommand: "gunicorn --bind :$PORT --workers 1 --threads 2 --timeout 120 wsgi:application"
    
    envVars:
      - key: PYTHON_VERSION
        value: 3.9.0
      - key: PYTHONUNBUFFERED
        value: 1
      - key: PORT
        value: 10000
      - key: PYTHONPATH
        value: /opt/render/project/src
    
    plan: free
    healthCheckPath: /health
